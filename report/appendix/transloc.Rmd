# Transition location effect (unconstrained mixture model)

```{r}
files <- list.files(str_c("../../stanout/", 
                          c("lift", "spl2", "plantra", "cato", "c2l1", "gunnexp2")), 
                    pattern = "mogbetaun.+.csv", 
                    full.names = T)

ps <- purrr::map_dfr(files, ~read_csv(.x) %>% 
  mutate(data = .x)) %>% 
  mutate(across(data, ~sub(".*/([^/]+)/[^/]+\\..*", "\\1", .)),
         across(data, ~recode_factor(., 
                "cato" = "CATO",# (non-dyslexic, unmasked)",
                "gunnexp2" = "GE2",# (unmasked)",
                "spl2" = "SPL2", # (L1)", 
#                "spl2 (shift + C)" = "SPL2 (L1; shift + C)", 
                "plantra" = "PLanTra",
                "lift" = "LIFT",
                "c2l1" = "C2L1",
                .ordered = TRUE))) %>% 
  filter(!(str_detect(data, "SPL2") & lang == "ES"),
         !(str_detect(data, "CATO") & group == "dyslexic"),
         !(str_detect(data, "CATO") & task == "masked"),
         !(str_detect(data, "GE2") & xn == "masked")) %>% 
  pivot_wider(names_from = param, 
              values_from = value) %>% 
  unnest(cols = beta:theta) %>% 
  mutate(across(c(beta, beta2), ~exp(.)),
         delta = beta2 - beta,
         across(location, ~str_replace(., " ", "\n"))) %>% 
  pivot_longer(beta:theta) %>% 
  summarise(across(value, 
                   list(mean = mean, 
                        lower = lower, 
                        upper = upper),
                   .names = "{.fn}"), 
            .by = c(data, location, name)) %>% 
  filter(name %in% c("beta", "delta", "prob"))
```



We present the mixture-model posterior estimates for each of the three parameter values in the three facets of Figure \ref{fig:crossstudypost}. Similar to the constrained mixture model, we aggregated the posterior across conditions^[We aggregated across pre-post test for the PLanTra dataset as well as genre and topic of the LIFT data set.] and removed conditions that might conflate comparisons^[We removed the masked writing condition in the GUNNEXP2 and CATO, the dyslexic group in the CATO data set, and L2 writing in the SPL2 data set.]. The resulting posterior allows us to examine differences between transition locations for each data set associated with each of the three mixture-model parameters.


<!-- We demonstrate in Appendix \ref{pre-post-test-plantra} and \ref{genre-effect-lift} respectively that there is negligible evidence of differences between these conditions.],  -->

<!-- ^[We removed the masked writing condition in the GUNNEXP2 and CATO, the dyslexic group in the CATO data set, and L2 writing in the SPL2 data set. Appendix \ref{masking-effect-cato-gunnexp2} and \ref{l2-effect-spl2} demonstrate that there is evidence for differences in parameter values for these manipulations.]. For posteriors of all conditions within data sets see Appendix \ref{posterior-parameter-estimates}.   -->



```{r crossstudypost, fig.cap="Mixture model parameter estimates across studies. Distributions of parameter estimates are represented as posterior mean and 95\\% probability interval (PI). Estimates for the CATO dataset were calculated for the non-dyslexic group, unmasked condition; also the GE2 estimtes represent the unmasked condition; SPL2 estimates are for the L1 group. Axes for interkey intervals are log-scaled for visability."}

posd <- position_dodge(.5)
dotsize <- 2.75
grouplabel <- "Data set:"
shapes <- c(1, 4, 6, 7, 8, 9, 11)
width <- 0
linewidth <- .35
nrow <- 1
beta <- filter(ps, name == "beta") %>% 
  mutate(name = beta_label) %>% 
  ggplot(aes(y = mean, 
             ymin = lower, 
             ymax = upper,
             x = location,
             shape = data,
             group = interaction(data))) +
  geom_line(linewidth = linewidth, 
            alpha = .75, 
            position = posd) +
  geom_errorbar(width = width, alpha = .75, position = posd) +
  geom_point(aes(colour = data), 
            size = dotsize, 
            position = posd) +
  facet_grid(~name) +
  scale_shape_manual(values = shapes) +
  scale_colour_colorblind() +
#  scale_y_log10(labels = scales::comma, breaks = c(50, 150, 200, 300, 400, 500)) +
  theme(axis.title = element_blank()) +
  labs(colour = grouplabel,
       shape = grouplabel) +
  guides(colour=guide_legend(nrow=nrow,byrow=TRUE),
         shape = guide_legend(nrow=nrow,byrow=TRUE))

delta <- filter(ps, name == "delta") %>% 
  mutate(name = delta_label,
         across(c(mean, lower, upper), ~./1000)) %>% 
  ggplot(aes(y = mean, 
             ymin = lower, 
             ymax = upper,
             x = location,
             shape = data,
             group = interaction(data))) +
  geom_line(linewidth = linewidth, alpha = .75, position = posd) +
  geom_errorbar(width = width, alpha = .75, position = posd) +
  geom_point(aes(colour = data), 
            size = dotsize, 
            position = posd) +
  facet_grid(~name) +
  scale_shape_manual(values = shapes) +
  scale_colour_colorblind() +
  #scale_y_(labels = scales::comma) +
  labs(colour = grouplabel,
       shape = grouplabel) +
  theme(axis.title = element_blank()) +
  guides(colour=guide_legend(nrow=nrow,byrow=TRUE),
         shape = guide_legend(nrow=nrow,byrow=TRUE))


theta <- filter(ps, name == "prob") %>% 
  mutate(name = theta_label) %>% 
  ggplot(aes(y = mean, 
             ymin = lower, 
             ymax = upper,
             x = location,
             shape = data,
             group = interaction(data))) +
  geom_line(linewidth = linewidth, alpha = .75, position = posd) +
  geom_errorbar(width = width, alpha = .75, position = posd) +
  geom_point(aes(colour = data), 
            size = dotsize, 
            position = posd) +
  facet_grid(~name) +
  scale_shape_manual(values = shapes) +
  scale_colour_colorblind() +
  scale_y_continuous(labels = dezero_plot, limits = c(0, 1)) +
  labs(colour = grouplabel,
       shape = grouplabel) +
  theme(axis.title = element_blank()) +
  guides(colour=guide_legend(nrow=nrow,byrow=TRUE),
         shape = guide_legend(nrow=nrow,byrow=TRUE))

plot <- beta + delta + theta + plot_layout(guides = "collect")

grid.arrange(patchworkGrob(plot), 
             left = "Posterior estimate with 95% PIs",
             bottom = "Transition location")

```


In the following we evaluate differences between transition locations for all three mixture model parameters. Figure \ref{fig:crossstudypost} shows largely the same patterns (with caveats) for keystroke interval estimates by transition location across data sets for all three mixture model parameters. We found that hesitations appear more frequently at before-word transitions than within words across data sets (all BFs > 100). Also hesitations are longer at before-sentence transitions compared to before-word transitions (all BFs > 100; except for C2L1: BF = 0.35 and LIFT = 2.14) and before-word transitions compared to within-word transitions (all BF > 10; except for LIFT: BF = 0.71). Further, we observed that fluent key-transitions are slower at before-word and before-sentence locations compared to within-word locations (all BFs > 100) but there is generally no evidence for a difference for fluent transitions for before-sentence transitions compared to before-word transitions (BFs < 0.08; except for SPL2: BF > 100 and GUNNEXP2: BF > 100). The full results of these pairwise comparisons can be found in Table \ref{tab:loceffect}.
 
Hesitation duration tends to be longer at before-sentence locations compared to before-word locations (except for data sets C2L1 and LIFT) and longer for before-word locations compared to within-word locations (except for the LIFT data set). However, for most data set there is negligible evidence for the idea that writers pause more frequently at before-sentence locations compared to before-word locations (except for data sets SPL2 and GUNNEXP2). This is interesting because it is generally believed that pausing behaviour is associated with syntactic edges such that more and longer pauses are predicted for key transitions at larger syntactic edges following the pattern before-sentence $>$ before-word $>$ within-word. In fact, the data set LIFT showed less pausing before sentences compared to before words. In brief, while keystroke transitions and pauses tend to be longer and more frequent at before-word locations compared to within-word transitions, it is not clear in which contexts keystroke transitions are before-sentence locations are slower, and their hesitations are longer and more frequent. 

Outstanding is the overall substantially longer fluent transitions for the C2L1 data. This is presumably reflecting that the population that this sample is from was the youngest among our data sets presumably involving the least experienced writers in our data pool. Hesitation duration and frequencies were similar to the other data sets. There are some inconsistencies for fluent before-sentence transitions compared to before-word transitions. Some data sets show before-sentence slowdowns for fluent transition compared to words. These inconsistencies could, to some extent, be explained on the basis that data sets differ as to whether before-sentence transitions involve complex key combination involve the mean or sum of transitions between space, shift and / or the sentence-initial letters. In particular, some data include the character key following the shift key at before sentence location (PLanTra, LIFT) but others did not scope over the character following the shift key (CATO, C2L1, SPL2, GUNNEXP2). Notice though that for the data sets PLanTra and LIFT, there was no evidence for a consistent differences between before-sentence and before-word transitions (except for longer hesitations in the PLanTra dataset). 

To address this finding, and inconsistency in how before-sentence transitions were timed, we test to what extent this difference affected the modelling results for the SPL2 data set. The results are shown in Appendix \ref{key-combination-effect-unconstrained-mixture-model}. We found that including the character following the shift key substantially extends both the transition duration and the hesitation duration but not the hesitation frequency. However, this conflicts with the absence of differences in data sets that included the character following shift at before-sentence transitions (PLanTra, LIFT). In other words, it is unlikely that patterns in our results can be explained on the basis of how before-keystroke transitions were operationalised (complex key-combinations at before-sentence locations).


\blandscape
```{r loceffect, results='asis'}
files <- list.files(str_c("../../stanout/", 
                          c("lift", "spl2", "gunnexp2", "plantra", "cato", "c2l1")), pattern = "mogbetaun.+.csv", full.names = T) # "spl2_shift",

ps_loc_diffs <- purrr::map_dfr(files, ~read_csv(.x) %>% 
                                 mutate(data = .x)) %>% 
  mutate(across(data, ~sub(".*/([^/]+)/[^/]+\\..*", "\\1", .)),
         across(data, ~recode(., 
                              "cato" = "*CATO* (non-dyslexic\nunmasked)",
                              "spl2" = "*SPL2* (L1)", 
                              "gunnexp2" = "*GE2* (unmasked)",
                              #                "spl2_shift" = "*SPL2* (L1; shift + C)", 
                              "plantra" = "*PLanTra*",
                              "lift" = "*LIFT*",
                              "c2l1" = "*C2L1*"))) %>% 
  filter(!(str_detect(data, "SPL2") & lang == "ES"),
         !(str_detect(data, "CATO") & group == "dyslexic"),
         !(str_detect(data, "CATO") & task == "masked"),
         !(str_detect(data, "GE2") & xn == "masked"),
         param %in% c("beta", "delta", "theta")) %>%
  select(param, location, data, value) %>% 
  mutate(across(value, ~ifelse(param == "theta", .*-1, .))) %>% 
  pivot_wider(names_from = location, values_from = value) %>%
  unnest(-c(data, param)) %>% 
  mutate(diff.1 = `before sentence` - `before word`,
         diff.2 = `before word` - `within word`) %>% 
  summarise(across(starts_with("diff"), 
                   list(mean = mean, 
                        lower = lower, 
                        upper = upper, 
                        BF = BF)),
            .by = c(data, param)) 

tmp <- ps_loc_diffs %>% 
  pivot_longer(starts_with("diff"), names_to = c("diffid", ".value"), names_sep = "_") %>% 
  mutate(across(mean, ~pmap_chr(list(., lower, upper, 2), PI)),
         across(BF, ~ifelse(.>100, "> 100", as.character(round(.,2))))) %>% 
  select(-lower, -upper) %>% 
  pivot_wider(names_from = param, values_from = c(mean, BF)) %>% 
  mutate(across(diffid, ~recode(., diff.1 = "before sentence vs word",
                                diff.2 = "before vs within word"))) %>% 
  select(data, diffid, ends_with("beta"), ends_with("delta"), ends_with("theta")) %>% 
  arrange(data)

write_csv(tmp, "../tables/location_effect_alldata.csv")

apa_table(tmp[,-1],
          align =c("l", rep("r", 6)), 
          longtable = T,
          escape = FALSE,
          row.names = T,
          font_size = "footnotesize",
          col.names = c("Comparison", rep(c("Est. [95\\% PIs]", "BF"), 3)),
          stub_indents = list(`\\textbf{C2L1}` = 1:2, 
                              `\\textbf{CATO (non-dyslexic, unmasked)}`= 3:4,
                              `\\textbf{GE2 (unmasked)}` = 5:6,
                              `\\textbf{LIFT}` = 7:8,
                              `\\textbf{PLanTra}` = 9:10,
                              `\\textbf{SPL2 (L1)}` = 11:12),
          #                              `\\textbf{SPL2 (L1; shift + C)}` = 13:14),
          col_spanners = list(" " = c(1),
                              "Fluent transitions" = c(2, 3), 
                              "Hesitation slowdown" = c(4, 5), 
                              "Hesitation probability" = c(6, 7)),
          note = "PI = probability intervals. BF = evidence in favour of the alternative hypothesis over the null hypothesis.",
          caption = "Effect of transition location on keystroke intervals. Differences are shown on log scale (for transition durations) and logit scale for probability of hesitant transitions. 95\\% PIs in brackets.") 


```
\elandscape

