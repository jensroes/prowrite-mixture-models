
```{r}
# get posterior
file <- list.files(path = "../../stanout/cato", 
                   pattern = "mogbetaco.+.csv$",
                   full.names = T)

ps <- read_csv(file) %>% filter(param %in% c("beta", "beta2", "prob")) 

ps_beta <- filter(ps, param == "beta") %>% 
  select(beta = value) %>% 
  mutate(idx = 1:n()) 

ps_cato <- ps %>% filter(param != "beta") %>% 
  pivot_wider(names_from = param, values_from = value) %>% 
  unnest(cols = c(beta2, prob)) %>% 
  mutate(idx = 1:n(), .by = where(is.character)) %>% 
  left_join(ps_beta, by = join_by(idx)) %>% 
  mutate(across(c(beta2, beta), exp),
         delta = beta2 - beta,
         across(location, str_replace, " ", "\n")) %>% 
  select(-beta2) %>% 
  pivot_longer(c(beta, prob, delta)) %>% 
  summarise(across(value, list(mean = mean, 
                               lower = lower, 
                               upper = upper), .names = "{.fn}"),
            .by = c(task, group, location, name)) %>% 
  mutate(group = str_c("Task: ", task, "; Group: ", group),
         ds = "CATO") %>% 
  select(-task)

file <- list.files(path = "../../stanout/c2l1", 
                   pattern = "mogbetacon.*.csv$",
                   full.names = T)

ps <- read_csv(file) %>% filter(param %in% c("beta", "beta2", "prob")) 

ps_beta <- filter(ps, param == "beta") %>% 
  select(beta = value) %>% 
  mutate(idx = 1:n()) 

ps_c2l1 <- ps %>% filter(param != "beta") %>% 
  pivot_wider(names_from = param, values_from = value) %>% 
  unnest(cols = c(beta2, prob)) %>% 
  mutate(idx = 1:n(), .by = where(is.character)) %>% 
  left_join(ps_beta,by = join_by(idx)) %>% 
  mutate(across(c(beta2, beta), exp),
         delta = beta2 - beta,
         across(location, str_replace, " ", "\n")) %>% 
  select(-beta2) %>% 
  pivot_longer(c(beta, prob, delta)) %>% 
  summarise(across(value, list(mean = mean, 
                               lower = lower, 
                               upper = upper), .names = "{.fn}"),
            .by = c(location, name)) %>% 
  mutate(ds = "C2L1",
         group = "1") 

file <- list.files(path = "../../stanout/gunnexp2", 
                   pattern = "mogbetacon.*.csv$",
                   full.names = T)

ps <- read_csv(file) %>% filter(param %in% c("beta", "beta2", "prob")) 

ps_beta <- filter(ps, param == "beta") %>% 
  select(beta = value) %>% 
  mutate(idx = 1:n()) 

ps_gunn <- ps %>% filter(param != "beta") %>% 
  pivot_wider(names_from = param, values_from = value) %>% 
  unnest(cols = c(beta2, prob)) %>% 
  mutate(idx = 1:n(), .by = where(is.character)) %>% 
  left_join(ps_beta, by = join_by(idx)) %>% 
  mutate(across(c(beta2, beta), exp),
         delta = beta2 - beta,
         across(location, str_replace, " ", "\n")) %>% 
  select(-beta2) %>% 
  pivot_longer(c(beta, prob, delta)) %>%
  summarise(across(value, list(mean = mean, 
                               lower = lower, 
                               upper = upper), .names = "{.fn}"),
            .by = c(location, xn, name)) %>% 
  mutate(ds = "GE2") %>% 
  rename(group = xn)

file <- list.files(path = "../../stanout/lift", 
                   pattern = "mogbetaco.+.csv$",
                   full.names = T)

ps <- read_csv(file) %>% filter(param %in% c("beta", "beta2", "prob")) 

ps_beta <- filter(ps, param == "beta") %>% 
  select(beta = value) %>% 
  mutate(idx = 1:n()) 

ps_lift <- ps %>% filter(param != "beta") %>% 
  mutate(across(genre, ~ifelse(is.na(genre), "Arg", .))) %>% 
  pivot_wider(names_from = param, values_from = value) %>% 
  unnest(cols = c(beta2, prob)) %>% 
  mutate(idx = 1:n(), .by = where(is.character)) %>% 
  left_join(ps_beta, by = join_by(idx)) %>% 
  mutate(across(c(beta2, beta), exp),
         delta = beta2 - beta,
         across(location, str_replace, " ", "\n")) %>% 
  select(-beta2) %>% 
  pivot_longer(c(beta, prob, delta)) %>%
  summarise(across(value, list(mean = mean, 
                               lower = lower, 
                               upper = upper), .names = "{.fn}"),
            .by = c(genre, topic, location, name)) %>% 
  mutate(group = str_c("Topic: ", topic, "; Genre: ", genre),
         ds = "LIFT") %>% 
  select(-topic, -genre)

file <- list.files(path = "../../stanout/plantra", 
                   pattern = "mogbetaco.+.csv$",
                   full.names = T)

ps <- read_csv(file) %>% filter(param %in% c("beta", "beta2", "prob")) 

ps_beta <- filter(ps, param == "beta") %>% 
  select(beta = value) %>% 
  mutate(idx = 1:n()) 

ps_plantra <- ps %>% filter(param != "beta") %>% 
  pivot_wider(names_from = param, values_from = value) %>% 
  unnest(cols = c(beta2, prob)) %>% 
  mutate(idx = 1:n(), .by = where(is.character)) %>% 
  left_join(ps_beta, by = join_by(idx)) %>% 
  mutate(across(c(beta2, beta), exp),
         delta = beta2 - beta,
         across(location, str_replace, " ", "\n")) %>% 
  select(-beta2) %>% 
  pivot_longer(c(beta, prob, delta)) %>%
  summarise(across(value, list(mean = mean, 
                               lower = lower, 
                               upper = upper), .names = "{.fn}"),
            .by = c(task, location, name)) %>% 
  mutate(ds = "PLanTra") %>% 
  rename(group = task)

file1 <- list.files(path = "../../stanout/spl2", 
                    pattern = "mogbetaco.+.csv$",
                    full.names = T)

file2 <- list.files(path = "../../stanout/spl2_shift", 
                    pattern = "mogbetaco.+.csv$",
                    full.names = T)

ps <- map_dfr(c(file1, file2), ~read_csv(.) %>% 
                     mutate(data = .x)) %>% 
  mutate(across(data, ~sub(".*/([^/]+)/[^/]+\\..*", "\\1", .)),
         across(data, ~recode(., spl2 = "SPL2 (_^[shift])",
                              spl2_shift = "SPL2 (_^[shift] + C)"))) %>% 
  filter(param %in% c("beta", "delta", "prob"))

ps_beta <- filter(ps, param == "beta") %>% 
  select(beta = value, data) %>% 
  mutate(idx = 1:n(), .by = data) 

ps_spl2_both <- ps %>% filter(param != "beta") %>% 
  pivot_wider(names_from = param, values_from = value) %>% 
  unnest(cols = c(delta, prob)) %>% 
  mutate(idx = 1:n(), .by = where(is.character)) %>% 
  left_join(ps_beta, by = join_by(idx, data)) %>% 
  mutate(across(lang, recode, "EN" = "L1", "ES" = "L2"),
         beta2 = beta + delta,
         across(c(beta2, beta), ~exp(.)),
         delta = beta2 - beta,
         across(location, str_replace, " ", "\n")) %>% 
  select(-beta2) %>% 
  pivot_longer(c(beta, prob, delta)) %>%
  summarise(across(value, list(mean = mean, 
                               lower = lower, 
                               upper = upper),
                   .names = "{.fn}"),
            .by = c(lang, location, name, data)) %>% 
  mutate(ds = "SPL2",
         group = str_c("Data: ", data, "; Language: ", lang)) %>% 
  select(-lang) 

ps_spl2 <- ps_spl2_both %>% filter(data == "SPL2 (_^[shift])")

# Combine all
ps <- bind_rows(ps_cato, ps_c2l1, ps_gunn, ps_lift, ps_plantra, ps_spl2)
```

# Key-combination effect (unconstrained mixture model)

The analysed datasets differ to the extent that keystroke intervals at before sentence location sometimes did (PLanTra, LIFT) or did not (CATO, C2L1, SPL2, GE2) scope over the character following the shift key. In other words, the pause before sentences sumed across two key intervals in the PLanTra and LIFT data, namely `_^[shift]^C` but only involved one key interval, namely `_^[shift]` for the remaining datasets. Therefore, longer or more frequent pauses at before-sentence locations compared to before-word locations can be explained without reference to linguistic edges. Also there is a possibility that some inconsistencies in our findings can be explained on the basis of including the keystroke following shift. 

Therefore we compared whether the different patterns can be explain on the basis of the additional keystroke involved in before-sentence transitions. We compared the SPL2 data including and excluding the keystroke after shift. Although we modelled all transition locations, we present only before-sentence transitions below as there was, as one would expect, no difference at word locations. The results of this comparison can be found in Table \ref{tab:shiftcellmeans2}. 

```{r shiftcellmeans2, results = 'asis'}
# cell means and data set difference
cellmeans <- ps_spl2 %>% 
  separate(group, into = c("group", "lang"), sep = "; ") %>%
  select(-ds, -group) %>%
  mutate(across(lang, ~str_remove(., "Language: ")),
         across(location, ~str_replace(., "\\n", " "))) %>% 
  pivot_wider(names_from = name, 
              values_from = c(mean, lower, upper)) %>% 
  mutate(across(ends_with("prob"), ~dezero(., 2)),
         across(c(ends_with("beta"),
                  ends_with("delta")), 
                ~as.character(scales::comma(round(.))))) %>% 
  pivot_longer(-c(lang, location, data), 
               names_to = c(".value", "param"),
               names_sep = "_") %>% 
  mutate(est = str_c(mean, " [", lower, ", ", upper,"]")) %>% 
  select(-mean:-upper) %>% 
  pivot_wider(names_from = data, 
              values_from = est) 

file1 <- list.files(path = "../../stanout/spl2", 
                    pattern = "mogbetaun.+.csv$",
                    full.names = T)

file2 <- list.files(path = "../../stanout/spl2_shift", 
                    pattern = "mogbetaun.+.csv$",
                    full.names = T)

tmp <- map_dfr(c(file1, file2), ~read_csv(.x) %>% 
                 mutate(data = .x)) %>% 
  filter(param %in% c("beta", "delta", "theta")) %>% 
  mutate(across(value, ~ifelse(param == "theta", .*-1, value))) %>% 
  mutate(across(lang, recode, "EN" = "L1", "ES" = "L2"),
         across(data, ~sub(".*/([^/]+)/[^/]+\\..*", "\\1", .))) %>% 
  pivot_wider(names_from = data, values_from = value) %>% 
  unnest(c(spl2, spl2_shift)) %>% 
  mutate(diff = spl2_shift - spl2) %>% 
  summarise(across(diff, list(mean = mean, 
                              lower = lower, 
                              upper = upper,
                              BF = BF), 
                   .names = "{.fn}"),
            .by = c(lang, location, param)) %>% 
  mutate(across(mean, ~pmap_chr(list(., lower, upper, 2), PI)),
         across(BF, ~ifelse(.>100, "> 100", as.character(round(.,2)))),
         across(param, recode, theta = "prob")) %>% 
  left_join(cellmeans) %>% 
  arrange(param, location, lang) %>% 
  filter(location == "before sentence") %>% 
  select(param, 
         Language = lang,
         `_^[shift] + C` = ends_with(" + C)"),
         `_^[shift]` = ends_with("FT])"),
         "Difference" = mean, BF)

write_csv(tmp, "../tables/shift_effect_cellmeans.csv")

apa_table(tmp[,-1],
          align = c("l", "r", "r", "r", "r"), 
          caption = "Mixture model estimates for interkey intervals. Cell means are shown for interkey intervals that do and do not involve the transition to the character following shift in msecs for fluent interkey intervals, the slowdown for long interkey intervals and the probability of hesitant interkey intervals. The difference for including the interkey intervals to the character after shift is shown on log scale (for interkey intervals) and logit scale for probability of hesitant interkey intervals. 95% PIs in brackets.",
          note = "PIs are probability intervals. BF is the evidence in favour of the alternative hypothesis over the null hypothesis.",
          font_size = "footnotesize",
          longtable = T,
          stub_indents = list("Fluent interkey intervals" = 1:2,
                              "Hesitation duration" = 3:4,
                              "Hesitation probability" = 5:6) )


```

Overall, fluent transition duration and the hesitation duration were affected by whether or not the sentence-initial transition include the character following shift. Fluent key transitions were substantially longer when including the interval following the shift key. The slowdown for hesitations was affected too but the difference is numerically small. There was no conclusive evidence for an increased hesitation probability. 